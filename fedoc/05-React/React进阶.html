<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>React 进阶 | 云息的面试资料库</title>
    <meta name="description" content="Code for a better world!">
    <link rel="icon" href="/logo.png">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#3eaf7c">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="/icons/apple-touch-icon-152x152.png">
  <link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#3eaf7c">
  <meta name="msapplication-TileImage" content="/icons/msapplication-icon-144x144.png">
  <meta name="msapplication-TileColor" content="#000000">
  <meta name="apple-mobile-web-app-status-bar-style">
    
    <link rel="preload" href="/assets/css/0.styles.05cc7eb5.css" as="style"><link rel="preload" href="/assets/js/app.dcf74adf.js" as="script"><link rel="preload" href="/assets/js/3.d459fbac.js" as="script"><link rel="preload" href="/assets/js/37.34ec6faf.js" as="script"><link rel="preload" href="/assets/js/6.da654ace.js" as="script"><link rel="prefetch" href="/assets/js/10.726ceeda.js"><link rel="prefetch" href="/assets/js/11.cc1411d8.js"><link rel="prefetch" href="/assets/js/12.2d961c16.js"><link rel="prefetch" href="/assets/js/13.4534349c.js"><link rel="prefetch" href="/assets/js/14.25b1e7f3.js"><link rel="prefetch" href="/assets/js/15.9a2ebaed.js"><link rel="prefetch" href="/assets/js/16.2e7b832c.js"><link rel="prefetch" href="/assets/js/17.c3355b63.js"><link rel="prefetch" href="/assets/js/18.853dd12d.js"><link rel="prefetch" href="/assets/js/19.d6bc92e9.js"><link rel="prefetch" href="/assets/js/20.79e63114.js"><link rel="prefetch" href="/assets/js/21.5b26b4a7.js"><link rel="prefetch" href="/assets/js/22.f545d988.js"><link rel="prefetch" href="/assets/js/23.1ef08a80.js"><link rel="prefetch" href="/assets/js/24.52c1504b.js"><link rel="prefetch" href="/assets/js/25.b85c6c7a.js"><link rel="prefetch" href="/assets/js/26.7e1ce755.js"><link rel="prefetch" href="/assets/js/27.b76dc2c4.js"><link rel="prefetch" href="/assets/js/28.728d4234.js"><link rel="prefetch" href="/assets/js/29.b0d656bb.js"><link rel="prefetch" href="/assets/js/30.86cd0a9c.js"><link rel="prefetch" href="/assets/js/31.18f13b4e.js"><link rel="prefetch" href="/assets/js/32.83a55f7d.js"><link rel="prefetch" href="/assets/js/33.8c2cb966.js"><link rel="prefetch" href="/assets/js/34.749d688a.js"><link rel="prefetch" href="/assets/js/35.0a7990df.js"><link rel="prefetch" href="/assets/js/36.8e1c8cef.js"><link rel="prefetch" href="/assets/js/38.8f5ef488.js"><link rel="prefetch" href="/assets/js/39.d32ba925.js"><link rel="prefetch" href="/assets/js/4.79676fe3.js"><link rel="prefetch" href="/assets/js/40.17ab7d00.js"><link rel="prefetch" href="/assets/js/41.68be4954.js"><link rel="prefetch" href="/assets/js/42.da32c428.js"><link rel="prefetch" href="/assets/js/43.3f651e5b.js"><link rel="prefetch" href="/assets/js/44.7e0185a5.js"><link rel="prefetch" href="/assets/js/45.309ead5b.js"><link rel="prefetch" href="/assets/js/46.6f7aeb62.js"><link rel="prefetch" href="/assets/js/47.361ce141.js"><link rel="prefetch" href="/assets/js/48.e6d8a8f3.js"><link rel="prefetch" href="/assets/js/49.33d9f0ac.js"><link rel="prefetch" href="/assets/js/5.51d5e42c.js"><link rel="prefetch" href="/assets/js/50.8b8c70c1.js"><link rel="prefetch" href="/assets/js/51.27f1ce7d.js"><link rel="prefetch" href="/assets/js/52.64320734.js"><link rel="prefetch" href="/assets/js/53.c732a5fa.js"><link rel="prefetch" href="/assets/js/54.541148e9.js"><link rel="prefetch" href="/assets/js/55.36cb41de.js"><link rel="prefetch" href="/assets/js/56.14a7959d.js"><link rel="prefetch" href="/assets/js/57.6a5f2316.js"><link rel="prefetch" href="/assets/js/58.1707cf09.js"><link rel="prefetch" href="/assets/js/59.176b3d1a.js"><link rel="prefetch" href="/assets/js/60.fbfd06af.js"><link rel="prefetch" href="/assets/js/61.c2d4f52a.js"><link rel="prefetch" href="/assets/js/62.0952ea43.js"><link rel="prefetch" href="/assets/js/63.40b1da1b.js"><link rel="prefetch" href="/assets/js/64.a4581053.js"><link rel="prefetch" href="/assets/js/65.72c37f85.js"><link rel="prefetch" href="/assets/js/66.33de2ae0.js"><link rel="prefetch" href="/assets/js/7.aa6f379f.js"><link rel="prefetch" href="/assets/js/8.d5676b08.js"><link rel="prefetch" href="/assets/js/9.e418b8d5.js"><link rel="prefetch" href="/assets/js/vendors~notification.7bcb2342.js">
    <link rel="stylesheet" href="/assets/css/0.styles.05cc7eb5.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">云息的面试资料库</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/fedoc/" class="nav-link router-link-active">指南</a></div><div class="nav-item"><a href="http://yunxi.site/blog/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/xiaomuzhu/front-end-interview" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/fedoc/" class="nav-link router-link-active">指南</a></div><div class="nav-item"><a href="http://yunxi.site/blog/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/xiaomuzhu/front-end-interview" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>01-计算机网络</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/fedoc/01-计算机网络/CDN和DNS.html" class="sidebar-link">CDN 和 DNS</a></li><li><a href="/fedoc/01-计算机网络/HTTP.html" class="sidebar-link">HTTP</a></li><li><a href="/fedoc/01-计算机网络/前端缓存最佳实践.html" class="sidebar-link">前端缓存最佳实践</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>02-CSS&amp;HTML</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/fedoc/02-CSS&amp;HTML/CSS 基础.html" class="sidebar-link">CSS 基础</a></li><li><a href="/fedoc/02-CSS&amp;HTML/HTML.html" class="sidebar-link">HTML</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>03-JavaScript</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/fedoc/03-JavaScript/JS 继承的八种写法.html" class="sidebar-link">JS 继承的八种写法</a></li><li><a href="/fedoc/03-JavaScript/JS异步编程原理.html" class="sidebar-link">JavaScript 异步编程原理</a></li><li><a href="/fedoc/03-JavaScript/JavaScript基础.html" class="sidebar-link">JS 基础</a></li><li><a href="/fedoc/03-JavaScript/异步-手写async_await.html" class="sidebar-link">异步—手写 async_await</a></li><li><a href="/fedoc/03-JavaScript/异步编程专题.html" class="sidebar-link">JS 异步编程：种类和原理</a></li><li><a href="/fedoc/03-JavaScript/手写系列.html" class="sidebar-link">手写系列</a></li><li><a href="/fedoc/03-JavaScript/防抖节流.html" class="sidebar-link">JavaScript防抖、节流以及rAF</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>04-游览器与BOM</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/fedoc/04-游览器与BOM/Cookie-Session ,JWT认证机制.html" class="sidebar-link">浅谈 Cookie-Session 、Jwt 两种身份认证机制</a></li><li><a href="/fedoc/04-游览器与BOM/Session的概念和安全问题.html" class="sidebar-link">有关 Session 的那些事儿</a></li><li><a href="/fedoc/04-游览器与BOM/V8优化之对象中的快属性与慢属性.html" class="sidebar-link">V8 优化之对象中的快属性与慢属性</a></li><li><a href="/fedoc/04-游览器与BOM/Web Storage 总结.html" class="sidebar-link">Cookie, Session, Web Storage与IndexedDB 总结</a></li><li><a href="/fedoc/04-游览器与BOM/前端安全.html" class="sidebar-link">前端安全</a></li><li><a href="/fedoc/04-游览器与BOM/前端路由的原理.html" class="sidebar-link">前端路由原理及实现</a></li><li><a href="/fedoc/04-游览器与BOM/原生事件.html" class="sidebar-link">原生事件</a></li><li><a href="/fedoc/04-游览器与BOM/跨域.html" class="sidebar-link">跨域</a></li><li><a href="/fedoc/04-游览器与BOM/输入URL1—输入URL和DNS_TCP_HTTP.html" class="sidebar-link">URL1—输入 URL 和游览器</a></li><li><a href="/fedoc/04-游览器与BOM/输入URL2—网络篇.html" class="sidebar-link">URL2—网络篇</a></li><li><a href="/fedoc/04-游览器与BOM/输入URL3—渲染树形成+原理.html" class="sidebar-link">URL3—渲染树形成+原理</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>05-React</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/fedoc/05-React/React基础.html" class="sidebar-link">React 基础</a></li><li><a href="/fedoc/05-React/React进阶.html" class="active sidebar-link">React 进阶</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fedoc/05-React/React进阶.html#目录" class="sidebar-link">目录</a></li><li class="sidebar-sub-header"><a href="/fedoc/05-React/React进阶.html#不能直接修改-state，要用不可变值" class="sidebar-link">不能直接修改 state，要用不可变值</a></li><li class="sidebar-sub-header"><a href="/fedoc/05-React/React进阶.html#setstate-可能是异步，也可能是同步" class="sidebar-link">setState 可能是异步，也可能是同步</a></li><li class="sidebar-sub-header"><a href="/fedoc/05-React/React进阶.html#vdom-和-diff-是-react-的基石" class="sidebar-link">VDOM 和 diff 是 React 的基石</a></li><li class="sidebar-sub-header"><a href="/fedoc/05-React/React进阶.html#合成事件机制" class="sidebar-link">合成事件机制</a></li><li class="sidebar-sub-header"><a href="/fedoc/05-React/React进阶.html#setstate-和-batchupdate" class="sidebar-link">setState 和 batchUpdate</a></li><li class="sidebar-sub-header"><a href="/fedoc/05-React/React进阶.html#组件渲染和更新" class="sidebar-link">组件渲染和更新</a></li><li class="sidebar-sub-header"><a href="/fedoc/05-React/React进阶.html#总结" class="sidebar-link">总结</a></li></ul></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>06-前端工程化</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/fedoc/06-前端工程化/Babel 工作原理.html" class="sidebar-link">Babel 是如何转换代码的？</a></li><li><a href="/fedoc/06-前端工程化/Git.html" class="sidebar-link">Git 相关</a></li><li><a href="/fedoc/06-前端工程化/webpack 的工作原理.html" class="sidebar-link">webpack 的工作原理</a></li><li><a href="/fedoc/06-前端工程化/webpack.html" class="sidebar-link">从零搭建 React 开发环境</a></li><li><a href="/fedoc/06-前端工程化/实现一个简易的webpack可选链loader.html" class="sidebar-link">optional-chaining-loader</a></li><li><a href="/fedoc/06-前端工程化/性能优化总结.html" class="sidebar-link">性能优化总结</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>07-前端架构</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/fedoc/07-前端架构/Node秒杀系统架构.html" class="sidebar-link">Node 秒杀系统架构</a></li><li><a href="/fedoc/07-前端架构/前端监控和埋点方案设计.html" class="sidebar-link">前端监控和前端埋点方案设计</a></li><li><a href="/fedoc/07-前端架构/支付宝架构师眼里的高并发架构.html" class="sidebar-link">支付宝架构师眼里的高并发架构</a></li><li><a href="/fedoc/07-前端架构/架构要考虑什么.html" class="sidebar-link">做架构要考虑什么？</a></li><li><a href="/fedoc/07-前端架构/说说前后端分离.html" class="sidebar-link">说说前后端分离</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>08-Node</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/fedoc/08-Node/Koa2深度解析.html" class="sidebar-link">Koa2 深度解析</a></li><li><a href="/fedoc/08-Node/Koa2源码和原理浅析.html" class="sidebar-link">Koa源码系列1—手写 Koa 库</a></li><li><a href="/fedoc/08-Node/Node.js多进程底层原理.html" class="sidebar-link">Node.js 多进程底层原理</a></li><li><a href="/fedoc/08-Node/Node.js调试之内存泄漏篇.html" class="sidebar-link">Node.js 调试之内存泄漏篇</a></li><li><a href="/fedoc/08-Node/初探 Node.js 中的事件循环.html" class="sidebar-link">初探 Node.js 中的事件循环</a></li><li><a href="/fedoc/08-Node/操作系统.html" class="sidebar-link">操作系统</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>09-算法和数据结构</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/fedoc/09-算法和数据结构/算法.html" class="sidebar-link">算法</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>10-知识广度</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/fedoc/10-知识广度/200409如何在数据库中存储密码更安全.html" class="sidebar-link">如何在数据库中存储密码更安全？</a></li><li><a href="/fedoc/10-知识广度/200410如何设计一个良好的API接口.html" class="sidebar-link">如何设计一个良好的 API 接口？</a></li><li><a href="/fedoc/10-知识广度/200411二维码扫描登录是什么原理.html" class="sidebar-link">二维码扫描登录是什么原理？</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="react-进阶"><a href="#react-进阶" aria-hidden="true" class="header-anchor">#</a> React 进阶</h1> <h2 id="目录"><a href="#目录" aria-hidden="true" class="header-anchor">#</a> 目录</h2> <p><strong>现象</strong></p> <ol><li>不可变值</li> <li>可能异步</li> <li>可能会被合并</li></ol> <p><strong>原理</strong></p> <ul><li>函数式编程</li> <li>VDOM 和 diff</li> <li>JSX 的本质</li> <li>合成事件</li> <li>setState batchUpdate</li> <li>组件渲染过程</li> <li>前端路由</li></ul> <h2 id="不能直接修改-state，要用不可变值"><a href="#不能直接修改-state，要用不可变值" aria-hidden="true" class="header-anchor">#</a> 不能直接修改 state，要用不可变值</h2> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 错误</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count<span class="token operator">++</span>
<span class="token comment">// 正确</span>
<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  count<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count<span class="token operator">++</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="setstate-可能是异步，也可能是同步"><a href="#setstate-可能是异步，也可能是同步" aria-hidden="true" class="header-anchor">#</a> setState 可能是异步，也可能是同步</h2> <p>直接使用是异步的</p> <p>setTimeout 中，setState 是同步的</p> <p>自己定义的 DOM 事件，setState 是同步的</p> <p>##合并</p> <h3 id="传入对象，会被合并，只执行一次-1"><a href="#传入对象，会被合并，只执行一次-1" aria-hidden="true" class="header-anchor">#</a> 传入对象，会被合并，只执行一次 +1</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  count<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token number">1</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  count<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token number">1</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  count<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token number">1</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 最终只加1</span>
<span class="token comment">// 类比：Object.assign</span>
</code></pre></div><h3 id="传入函数，不会被合并"><a href="#传入函数，不会被合并" aria-hidden="true" class="header-anchor">#</a> 传入函数，不会被合并</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token parameter">prevState</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  count<span class="token punctuation">:</span> prevState<span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token number">1</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token parameter">prevState</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  count<span class="token punctuation">:</span> prevState<span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token number">1</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token parameter">prevState</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  count<span class="token punctuation">:</span> prevState<span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token number">1</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 函数无法合并</span>
</code></pre></div><h1 id="原理梳理"><a href="#原理梳理" aria-hidden="true" class="header-anchor">#</a> 原理梳理</h1> <p>函数式编程</p> <ul><li>一种编程范式</li> <li>纯函数</li> <li>不可变值</li></ul> <h2 id="vdom-和-diff-是-react-的基石"><a href="#vdom-和-diff-是-react-的基石" aria-hidden="true" class="header-anchor">#</a> VDOM 和 diff 是 React 的基石</h2> <h3 id="vdom"><a href="#vdom" aria-hidden="true" class="header-anchor">#</a> VDOM</h3> <p>h 函数</p> <p>vnode 数据结构，树</p> <p><img src="https://tva1.sinaimg.cn/large/0082zybply1gc8zfcbh0nj30am0do0tw.jpg" alt="image-20200225214648201"></p> <p>patch 函数</p> <h3 id="diff-算法"><a href="#diff-算法" aria-hidden="true" class="header-anchor">#</a> diff 算法</h3> <ul><li>同级比较</li> <li>tag 不同，则直接删掉重建，不再深度比较</li> <li>tag 和 key，两者都相同，则认为是相同节点，不再深度比较</li></ul> <p>O(n^3) 改进为 O(n)</p> <h3 id="jsx-的本质？"><a href="#jsx-的本质？" aria-hidden="true" class="header-anchor">#</a> JSX 的本质？</h3> <p>JSX 不是 JS。</p> <ul><li>编译后成为一堆 <code>React.createElement()</code> ；</li> <li><code>React.createElement()</code> 执行返回的是一个 vnode，能通过后续的 patch 来渲染；</li> <li>第一个参数，可能是组件，也可能是个 HTML 标签；</li> <li>组件名首字母必须大写，就是为了区分组件和 tag。</li></ul> <h2 id="合成事件机制"><a href="#合成事件机制" aria-hidden="true" class="header-anchor">#</a> 合成事件机制</h2> <ul><li>event 是 SyntheticEvent，模拟出 DOM 事件所有能力</li> <li>event.nativeEvent 是原生对象事件</li> <li>所有的事件，都被挂载到 document 上</li> <li>和 DOM 事件不一样</li></ul> <p><img src="https://tva1.sinaimg.cn/large/0082zybply1gc90bxjx1dj30q00bjtbg.jpg" alt="image-20200225221807193"></p> <p>React 通过这种合成事件机制，模拟了每一个原生 event 的行为。相当于在原生 event 上包装了一层。</p> <h3 id="为什么需要合成事件机制"><a href="#为什么需要合成事件机制" aria-hidden="true" class="header-anchor">#</a> 为什么需要合成事件机制</h3> <ul><li>更好的兼容性和跨平台</li> <li>挂载到 document 上，<strong>减少内存消耗</strong>，避免频繁解绑 （事件委托？）
<ul><li>比如 <code>&lt;a onClick={fn} /&gt;</code>，其实没有直接在 a 上挂事件，而是挂载 document 上，这样当组件销毁的时候也不用去解绑</li></ul></li> <li>方便事件统一管理（如事物机制）</li></ul> <h2 id="setstate-和-batchupdate"><a href="#setstate-和-batchupdate" aria-hidden="true" class="header-anchor">#</a> setState 和 batchUpdate</h2> <p><strong>回顾现象：</strong></p> <ul><li>setState 有时<strong>异步</strong>（普通使用），有时<strong>同步</strong>（setTimeout，DOM 事件）</li> <li>有时合并（对象形式），有时不合并（函数形式）</li> <li>后者好理解（类似 Object.assign），主要理解 setState</li></ul> <p><strong>核心要点：</strong></p> <ul><li>setState 的主要流程</li> <li>batchUpdate 机制</li> <li>transaction （事务）机制</li></ul> <h3 id="setstate-的流程"><a href="#setstate-的流程" aria-hidden="true" class="header-anchor">#</a> setState 的流程</h3> <p><img src="https://tva1.sinaimg.cn/large/0082zybply1gc9gqugd88j30ht0cemz9.jpg" alt="image-20200226074600085"></p> <p>上面的结果最终是 1，在<code>setState</code>的时候 react 内部会创建一个<code>updateQueue</code>，通过<code>firstUpdate</code>、<code>lastUpdate</code>、<code>lastUpdate.next</code>去维护一个更新的队列，在最终的<code>performWork</code>中，相同的 key 会被覆盖，只会对最后一次的<code>setState</code>进行更新。</p> <h3 id="batchupdate-机制以及-isbatchingupdates"><a href="#batchupdate-机制以及-isbatchingupdates" aria-hidden="true" class="header-anchor">#</a> batchUpdate 机制以及 isBatchingUpdates</h3> <p>举个 🌰，放在 setTimeout 中</p> <p><img src="https://tva1.sinaimg.cn/large/0082zybply1gc9gtpyrobj30sp0d20zu.jpg" alt="image-20200226074848656"></p> <p>看右边，开始处于 <code>batchUpdate</code> 中，<code>isBatchingUpdates = true</code>，接着开始执行 <code>setTimeout</code>，但是里面的 <code>setState</code> 是异步的，所以还没执行，紧接着 <code>isBatchingUpdates = false</code> 。因此之后 <code>setState</code> 执行的时候，<code>isBatchingUpdates = false</code> ，所以开始走流程图的右边了。</p> <p>其实 React 所有函数都是这样的逻辑。</p> <p>自定义事件也是一样的：</p> <p><img src="https://tva1.sinaimg.cn/large/0082zybply1gc9gzybiulj30lt0bjgqd.jpg" alt="image-20200226075447475"></p> <p>总结：</p> <ul><li>同步异步不是由 setState 自己决定的</li> <li>就是看能否命中 batchUpdate 机制</li> <li>判断 <code>isBatchingUpdate</code></li></ul> <p>能命中 batchUpdate 机制：</p> <ul><li>生命周期以及其调用的函数</li> <li>React 中注册的事件（和它调用的函数）</li> <li>React 可以“管理”的入口</li></ul> <p>不能命中：</p> <ul><li>setTimeout，setInterval（和它调用的函数）</li> <li>自定义的 DOM 事件</li> <li>React “管不到” 的入口，不是 React 那儿注册的</li></ul> <h3 id="transction-机制"><a href="#transction-机制" aria-hidden="true" class="header-anchor">#</a> transction 机制</h3> <p>![image-20200226080322386](/Users/husiyuan/Library/Application Support/typora-user-images/image-20200226080322386.png)</p> <p><img src="https://tva1.sinaimg.cn/large/0082zybply1gc9ha7qr8hj30jq0d7gpa.jpg" alt="image-20200226080439053"></p> <p>可以看到，这两个<code>wrapper</code>的<code>initialize</code>都没有做什么事情，但是在 callback 执行完之后，<code>RESET_BATCHED_UPDATES</code> 的作用是将<code>isBatchingUpdates</code>置为<code>false</code>, <code>FLUSH_BATCHED_UPDATES</code> 的作用是执行<code>flushBatchedUpdates</code>,然后里面会循环所有<code>dirtyComponent</code>,调用<code>updateComponent</code>来执行所有的生命周期方法，<code>componentWillReceiveProps</code>, <code>shouldComponentUpdate</code>, <code>componentWillUpdate</code>, <code>render</code>, <code>componentDidUpdate</code> 最后实现组件的更新。</p> <h2 id="组件渲染和更新"><a href="#组件渲染和更新" aria-hidden="true" class="header-anchor">#</a> 组件渲染和更新</h2> <h3 id="组件渲染和更新的过程"><a href="#组件渲染和更新的过程" aria-hidden="true" class="header-anchor">#</a> 组件渲染和更新的过程</h3> <ul><li><code>setState(newState)</code> =&gt; dirtyComponents （可能有子组件）</li> <li><code>render()</code> 生成 newVnode</li> <li><code>patch(vnode, newVnode)</code> <ol><li>reconciliation 阶段：执行 diff 算法，纯 JS 计算</li> <li>commit 阶段：将 diff 结果渲染到 DOM</li></ol></li></ul> <h3 id="为何-patch-分为两个阶段？"><a href="#为何-patch-分为两个阶段？" aria-hidden="true" class="header-anchor">#</a> 为何 patch 分为两个阶段？</h3> <ul><li>js 是单线程的，和 DOM 渲染公用一个线程（类比回流的过程）</li> <li>组件复杂的时候，组件更新计算和渲染都压力很大</li> <li>同时有 DOM 操作需求的时候（动画、鼠标拖拽），会卡顿。解决方案是 <code>fiber</code></li></ul> <h3 id="何为-fiber"><a href="#何为-fiber" aria-hidden="true" class="header-anchor">#</a> 何为 fiber</h3> <p>单线程调度算法</p> <p><a href="https://juejin.im/post/5ab7b3a2f265da2378403e57" target="_blank" rel="noopener noreferrer">fiber 介绍<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>react 在进行组件渲染时，从 setState 开始到渲染完成整个过程是同步的（“一气呵成”）。如果需要渲染的组件比较庞大，js 执行会占据主线程时间较长，会导致页面响应度变差，使得 react 在动画、手势等应用中效果比较差。</p> <p>为了解决这个问题，react 团队经过两年的工作，重写了 react 中核心算法——<a href="https://reactjs.org/docs/reconciliation.html" target="_blank" rel="noopener noreferrer">reconciliation<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。并在 v16 版本中发布了这个新的特性。为了区别之前和之后的 reconciler，通常将之前的 reconciler 称为 stack reconciler，重写后的称为 fiber reconciler，简称为 Fiber。</p> <ul><li>将 reconciliation（重写了） 阶段进行拆分（commit 无法拆分，一次执行完）</li> <li>DOM 需要渲染时候暂停，空闲时恢复</li> <li>何时暂停何时恢复呢？ <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Window/requestIdleCallback" target="_blank" rel="noopener noreferrer">window.requestIdleCallback<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> (Edge,IE,Safari 不支持，用 polyfill)</li></ul> <h2 id="总结"><a href="#总结" aria-hidden="true" class="header-anchor">#</a> 总结</h2> <ul><li>函数式编程：纯函数，不可变值</li> <li>VDOM 和 diff</li> <li>JSX 的本质</li> <li>合成事件</li> <li>setState 和 batchUpdate</li> <li>组件渲染和更新的过程</li> <li>fiber 架构</li></ul></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/xiaomuzhu/front-end-interview/edit/master/fedoc/05-React/React进阶.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/fedoc/05-React/React基础.html" class="prev">
          React 基础
        </a></span> <span class="next"><a href="/fedoc/06-前端工程化/Babel 工作原理.html">
          Babel 是如何转换代码的？
        </a>
        →
      </span></p></div> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/assets/js/app.dcf74adf.js" defer></script><script src="/assets/js/3.d459fbac.js" defer></script><script src="/assets/js/37.34ec6faf.js" defer></script><script src="/assets/js/6.da654ace.js" defer></script>
  </body>
</html>
