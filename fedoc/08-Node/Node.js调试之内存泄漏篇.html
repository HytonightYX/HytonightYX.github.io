<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Node.js 调试之内存泄漏篇 | 云息的面试资料库</title>
    <meta name="description" content="Code for a better world!">
    <link rel="icon" href="/logo.png">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#3eaf7c">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="/icons/apple-touch-icon-152x152.png">
  <link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#3eaf7c">
  <meta name="msapplication-TileImage" content="/icons/msapplication-icon-144x144.png">
  <meta name="msapplication-TileColor" content="#000000">
  <meta name="apple-mobile-web-app-status-bar-style">
    
    <link rel="preload" href="/assets/css/0.styles.05cc7eb5.css" as="style"><link rel="preload" href="/assets/js/app.dcf74adf.js" as="script"><link rel="preload" href="/assets/js/3.d459fbac.js" as="script"><link rel="preload" href="/assets/js/52.64320734.js" as="script"><link rel="preload" href="/assets/js/6.da654ace.js" as="script"><link rel="prefetch" href="/assets/js/10.726ceeda.js"><link rel="prefetch" href="/assets/js/11.cc1411d8.js"><link rel="prefetch" href="/assets/js/12.2d961c16.js"><link rel="prefetch" href="/assets/js/13.4534349c.js"><link rel="prefetch" href="/assets/js/14.25b1e7f3.js"><link rel="prefetch" href="/assets/js/15.9a2ebaed.js"><link rel="prefetch" href="/assets/js/16.2e7b832c.js"><link rel="prefetch" href="/assets/js/17.c3355b63.js"><link rel="prefetch" href="/assets/js/18.853dd12d.js"><link rel="prefetch" href="/assets/js/19.d6bc92e9.js"><link rel="prefetch" href="/assets/js/20.79e63114.js"><link rel="prefetch" href="/assets/js/21.5b26b4a7.js"><link rel="prefetch" href="/assets/js/22.f545d988.js"><link rel="prefetch" href="/assets/js/23.1ef08a80.js"><link rel="prefetch" href="/assets/js/24.52c1504b.js"><link rel="prefetch" href="/assets/js/25.b85c6c7a.js"><link rel="prefetch" href="/assets/js/26.7e1ce755.js"><link rel="prefetch" href="/assets/js/27.b76dc2c4.js"><link rel="prefetch" href="/assets/js/28.728d4234.js"><link rel="prefetch" href="/assets/js/29.b0d656bb.js"><link rel="prefetch" href="/assets/js/30.86cd0a9c.js"><link rel="prefetch" href="/assets/js/31.18f13b4e.js"><link rel="prefetch" href="/assets/js/32.83a55f7d.js"><link rel="prefetch" href="/assets/js/33.8c2cb966.js"><link rel="prefetch" href="/assets/js/34.749d688a.js"><link rel="prefetch" href="/assets/js/35.0a7990df.js"><link rel="prefetch" href="/assets/js/36.8e1c8cef.js"><link rel="prefetch" href="/assets/js/37.34ec6faf.js"><link rel="prefetch" href="/assets/js/38.8f5ef488.js"><link rel="prefetch" href="/assets/js/39.d32ba925.js"><link rel="prefetch" href="/assets/js/4.79676fe3.js"><link rel="prefetch" href="/assets/js/40.17ab7d00.js"><link rel="prefetch" href="/assets/js/41.68be4954.js"><link rel="prefetch" href="/assets/js/42.da32c428.js"><link rel="prefetch" href="/assets/js/43.3f651e5b.js"><link rel="prefetch" href="/assets/js/44.7e0185a5.js"><link rel="prefetch" href="/assets/js/45.309ead5b.js"><link rel="prefetch" href="/assets/js/46.6f7aeb62.js"><link rel="prefetch" href="/assets/js/47.361ce141.js"><link rel="prefetch" href="/assets/js/48.e6d8a8f3.js"><link rel="prefetch" href="/assets/js/49.33d9f0ac.js"><link rel="prefetch" href="/assets/js/5.51d5e42c.js"><link rel="prefetch" href="/assets/js/50.8b8c70c1.js"><link rel="prefetch" href="/assets/js/51.27f1ce7d.js"><link rel="prefetch" href="/assets/js/53.c732a5fa.js"><link rel="prefetch" href="/assets/js/54.541148e9.js"><link rel="prefetch" href="/assets/js/55.36cb41de.js"><link rel="prefetch" href="/assets/js/56.14a7959d.js"><link rel="prefetch" href="/assets/js/57.6a5f2316.js"><link rel="prefetch" href="/assets/js/58.1707cf09.js"><link rel="prefetch" href="/assets/js/59.176b3d1a.js"><link rel="prefetch" href="/assets/js/60.fbfd06af.js"><link rel="prefetch" href="/assets/js/61.c2d4f52a.js"><link rel="prefetch" href="/assets/js/62.0952ea43.js"><link rel="prefetch" href="/assets/js/63.40b1da1b.js"><link rel="prefetch" href="/assets/js/64.a4581053.js"><link rel="prefetch" href="/assets/js/65.72c37f85.js"><link rel="prefetch" href="/assets/js/66.33de2ae0.js"><link rel="prefetch" href="/assets/js/7.aa6f379f.js"><link rel="prefetch" href="/assets/js/8.d5676b08.js"><link rel="prefetch" href="/assets/js/9.e418b8d5.js"><link rel="prefetch" href="/assets/js/vendors~notification.7bcb2342.js">
    <link rel="stylesheet" href="/assets/css/0.styles.05cc7eb5.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">云息的面试资料库</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/fedoc/" class="nav-link router-link-active">指南</a></div><div class="nav-item"><a href="http://yunxi.site/blog/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/xiaomuzhu/front-end-interview" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/fedoc/" class="nav-link router-link-active">指南</a></div><div class="nav-item"><a href="http://yunxi.site/blog/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/xiaomuzhu/front-end-interview" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>01-计算机网络</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/fedoc/01-计算机网络/CDN和DNS.html" class="sidebar-link">CDN 和 DNS</a></li><li><a href="/fedoc/01-计算机网络/HTTP.html" class="sidebar-link">HTTP</a></li><li><a href="/fedoc/01-计算机网络/前端缓存最佳实践.html" class="sidebar-link">前端缓存最佳实践</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>02-CSS&amp;HTML</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/fedoc/02-CSS&amp;HTML/CSS 基础.html" class="sidebar-link">CSS 基础</a></li><li><a href="/fedoc/02-CSS&amp;HTML/HTML.html" class="sidebar-link">HTML</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>03-JavaScript</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/fedoc/03-JavaScript/JS 继承的八种写法.html" class="sidebar-link">JS 继承的八种写法</a></li><li><a href="/fedoc/03-JavaScript/JS异步编程原理.html" class="sidebar-link">JavaScript 异步编程原理</a></li><li><a href="/fedoc/03-JavaScript/JavaScript基础.html" class="sidebar-link">JS 基础</a></li><li><a href="/fedoc/03-JavaScript/异步-手写async_await.html" class="sidebar-link">异步—手写 async_await</a></li><li><a href="/fedoc/03-JavaScript/异步编程专题.html" class="sidebar-link">JS 异步编程：种类和原理</a></li><li><a href="/fedoc/03-JavaScript/手写系列.html" class="sidebar-link">手写系列</a></li><li><a href="/fedoc/03-JavaScript/防抖节流.html" class="sidebar-link">JavaScript防抖、节流以及rAF</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>04-游览器与BOM</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/fedoc/04-游览器与BOM/Cookie-Session ,JWT认证机制.html" class="sidebar-link">浅谈 Cookie-Session 、Jwt 两种身份认证机制</a></li><li><a href="/fedoc/04-游览器与BOM/Session的概念和安全问题.html" class="sidebar-link">有关 Session 的那些事儿</a></li><li><a href="/fedoc/04-游览器与BOM/V8优化之对象中的快属性与慢属性.html" class="sidebar-link">V8 优化之对象中的快属性与慢属性</a></li><li><a href="/fedoc/04-游览器与BOM/Web Storage 总结.html" class="sidebar-link">Cookie, Session, Web Storage与IndexedDB 总结</a></li><li><a href="/fedoc/04-游览器与BOM/前端安全.html" class="sidebar-link">前端安全</a></li><li><a href="/fedoc/04-游览器与BOM/前端路由的原理.html" class="sidebar-link">前端路由原理及实现</a></li><li><a href="/fedoc/04-游览器与BOM/原生事件.html" class="sidebar-link">原生事件</a></li><li><a href="/fedoc/04-游览器与BOM/跨域.html" class="sidebar-link">跨域</a></li><li><a href="/fedoc/04-游览器与BOM/输入URL1—输入URL和DNS_TCP_HTTP.html" class="sidebar-link">URL1—输入 URL 和游览器</a></li><li><a href="/fedoc/04-游览器与BOM/输入URL2—网络篇.html" class="sidebar-link">URL2—网络篇</a></li><li><a href="/fedoc/04-游览器与BOM/输入URL3—渲染树形成+原理.html" class="sidebar-link">URL3—渲染树形成+原理</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>05-React</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/fedoc/05-React/React基础.html" class="sidebar-link">React 基础</a></li><li><a href="/fedoc/05-React/React进阶.html" class="sidebar-link">React 进阶</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>06-前端工程化</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/fedoc/06-前端工程化/Babel 工作原理.html" class="sidebar-link">Babel 是如何转换代码的？</a></li><li><a href="/fedoc/06-前端工程化/Git.html" class="sidebar-link">Git 相关</a></li><li><a href="/fedoc/06-前端工程化/webpack 的工作原理.html" class="sidebar-link">webpack 的工作原理</a></li><li><a href="/fedoc/06-前端工程化/webpack.html" class="sidebar-link">从零搭建 React 开发环境</a></li><li><a href="/fedoc/06-前端工程化/实现一个简易的webpack可选链loader.html" class="sidebar-link">optional-chaining-loader</a></li><li><a href="/fedoc/06-前端工程化/性能优化总结.html" class="sidebar-link">性能优化总结</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>07-前端架构</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/fedoc/07-前端架构/Node秒杀系统架构.html" class="sidebar-link">Node 秒杀系统架构</a></li><li><a href="/fedoc/07-前端架构/前端监控和埋点方案设计.html" class="sidebar-link">前端监控和前端埋点方案设计</a></li><li><a href="/fedoc/07-前端架构/支付宝架构师眼里的高并发架构.html" class="sidebar-link">支付宝架构师眼里的高并发架构</a></li><li><a href="/fedoc/07-前端架构/架构要考虑什么.html" class="sidebar-link">做架构要考虑什么？</a></li><li><a href="/fedoc/07-前端架构/说说前后端分离.html" class="sidebar-link">说说前后端分离</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>08-Node</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/fedoc/08-Node/Koa2深度解析.html" class="sidebar-link">Koa2 深度解析</a></li><li><a href="/fedoc/08-Node/Koa2源码和原理浅析.html" class="sidebar-link">Koa源码系列1—手写 Koa 库</a></li><li><a href="/fedoc/08-Node/Node.js多进程底层原理.html" class="sidebar-link">Node.js 多进程底层原理</a></li><li><a href="/fedoc/08-Node/Node.js调试之内存泄漏篇.html" class="active sidebar-link">Node.js 调试之内存泄漏篇</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fedoc/08-Node/Node.js调试之内存泄漏篇.html#前言" class="sidebar-link">前言</a></li><li class="sidebar-sub-header"><a href="/fedoc/08-Node/Node.js调试之内存泄漏篇.html#内存泄漏" class="sidebar-link">内存泄漏</a></li><li class="sidebar-sub-header"><a href="/fedoc/08-Node/Node.js调试之内存泄漏篇.html#案例分析" class="sidebar-link">案例分析</a></li><li class="sidebar-sub-header"><a href="/fedoc/08-Node/Node.js调试之内存泄漏篇.html#内存分析" class="sidebar-link">内存分析</a></li><li class="sidebar-sub-header"><a href="/fedoc/08-Node/Node.js调试之内存泄漏篇.html#原因分析" class="sidebar-link">原因分析</a></li></ul></li><li><a href="/fedoc/08-Node/初探 Node.js 中的事件循环.html" class="sidebar-link">初探 Node.js 中的事件循环</a></li><li><a href="/fedoc/08-Node/操作系统.html" class="sidebar-link">操作系统</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>09-算法和数据结构</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/fedoc/09-算法和数据结构/算法.html" class="sidebar-link">算法</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>10-知识广度</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/fedoc/10-知识广度/200409如何在数据库中存储密码更安全.html" class="sidebar-link">如何在数据库中存储密码更安全？</a></li><li><a href="/fedoc/10-知识广度/200410如何设计一个良好的API接口.html" class="sidebar-link">如何设计一个良好的 API 接口？</a></li><li><a href="/fedoc/10-知识广度/200411二维码扫描登录是什么原理.html" class="sidebar-link">二维码扫描登录是什么原理？</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="node-js-调试之内存泄漏篇"><a href="#node-js-调试之内存泄漏篇" aria-hidden="true" class="header-anchor">#</a> Node.js 调试之内存泄漏篇</h1> <h2 id="前言"><a href="#前言" aria-hidden="true" class="header-anchor">#</a> 前言</h2> <p>JavaScript 是一种垃圾回收（Garbage Collection，GC）语言，Node 进程使用的内存一般都是通过 JavaScript 引擎来分配和回收的，比如 V8。</p> <p>V8 怎么知道内存在什么时候需要回收呢？从根节点开始，V8 使用图来描述程序中的变量，在浏览器中这个根节点是 window 对象，在 Node 中这个根节点是 global 对象。之后 V8 会定期遍历这个图，识别出那些从根节点无法访问到的数据，这些数据不会再使用，内存需要被释放掉，这个过程被叫做垃圾回收（GC）。</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/ttVWurLoGViaXQR6jiaFpgHt6ib3dwFZibskHDCJhpiarnsaaqtvxDrnVrsZfDKEluPMicCpeqVyUEeqbibQRj2pOc9Ig/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="img"></p> <h2 id="内存泄漏"><a href="#内存泄漏" aria-hidden="true" class="header-anchor">#</a> 内存泄漏</h2> <p>什么是内存泄漏呢？很简单，一些不再需要的数据仍然可以从根节点访问，本应被回收的内存没被回收，这就是内存泄漏。为了调试内存泄漏，我们需要定位哪些数据被错误的保留，然后修改代码使得 V8 能够正确的回收这些数据的内存。需要注意的是，垃圾回收并不会一直运行，而是在需要的时候运行，比如周期性的运行，或者当可用内存降低到一定程度的时候运行。</p> <p>那么什么时候可能出现内存泄漏呢？当您应用的性能随着时间的推移逐渐变差，重启后性能又变好，这种情况很可能出现了内存泄漏。我们又该如何定位呢？下面我们使用 heapdump 和 Chrome 开发者工具（DevTools）来分析一个经典的内存泄漏案例。</p> <h2 id="案例分析"><a href="#案例分析" aria-hidden="true" class="header-anchor">#</a> 案例分析</h2> <p>要分析的代码很简单，如下图所示（index.js）：</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/ttVWurLoGViaXQR6jiaFpgHt6ib3dwFZibskDdcfyeqibWaq9wkU8HTzq5BSI9lWr0ELhymQ4Sibym4icGa4ljBWiaC1aA/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="img"></p> <p>前端高手可能一眼就看出这段代码的问题，如果你看出来了，请假装没看出来，这样我们才有继续分析下去的必要<img src="https://res.wx.qq.com/mpres/htmledition/images/icon/common/emotion_panel/smiley/smiley_44.png?tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="img">。</p> <p>接下来让我们首先运行一下这个程序 —— node index.js，然后执行 kill -USR2 <code>pgrep -n node</code>命令生成 dump 文件，&quot;pgrep -n node&quot;是用来获取 node 进程 pid 的，kill -USR2 <pid>是 heapdump 生成 dump 文件的一个命令，具体请参考https://github.com/bnoordhuis/node-heapdump。至于dump文件是什么，如果您还不知道的话，请参考我们之前写的<a href="http://mp.weixin.qq.com/s?__biz=MzU5MjczNTg2MQ==&amp;mid=2247484033&amp;idx=1&amp;sn=e159cb2217b45d2a374ed60663e916db&amp;chksm=fe1a799bc96df08d9a2cc1885689688ff622b8374c87fb93da1e6c730bb514ff2906f9f5c904&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">Node.js调试之llnode篇<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，这里面有讲解。</pid></p> <p>这里我执行了 3 次 kill -USR2 <code>pgrep -n node</code>，生成了 3 个 dump 文件，具体如下：</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_jpg/ttVWurLoGViaXQR6jiaFpgHt6ib3dwFZibskMC7jPhqphHrj4psdPNhd3RK3M97wxQia3nk64995vRm0apAWEKWtDAA/640?wx_fmt=jpeg&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="img"></p> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/ttVWurLoGViaXQR6jiaFpgHt6ib3dwFZibskVQOibNzSibv82Y5nicNHy2p7gSN12aM2pQA27UIzwI31cFeWRB1Udz2zw/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="img"></p> <h2 id="内存分析"><a href="#内存分析" aria-hidden="true" class="header-anchor">#</a> 内存分析</h2> <p>现在我们获得了 3 个 dump 文件，由于 Node 是依赖 V8 引擎执行 JavaScript 的，Chrome 浏览器也是，所以我们可以借助 Chrome 开发者工具中的 Memory 模块来分析这些 dump 文件。首先打开 Chrome 的开发者工具，切换到 Memory，并依次加载 dump 文件。</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/ttVWurLoGViaXQR6jiaFpgHt6ib3dwFZibsk9fw52ib2DBUZ3CnbaK2QszFo86YweaZStudDnRQ016dZwia9K8JgHqUA/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="img"></p> <p>加载完 dump 文件后，图中框起来的部分会有 4 个选项，我们会用到 Summary 和 Comparison 两个选项，所以只会解释着两个部分，如果您对其他两个选项有兴趣的话，可以参考:</p> <p>https://developers.google.com/web/tools/chrome-devtools/memory-problems。</p> <p><strong>Comparison</strong></p> <p>首先看一下 Comparison 这个选项，从图中可以看到有 Constructor、New、Deleted、Delta、Alloc Size、Freed Size、Size Delta 共 7 列。Constructor 这列是用类名对变量进行分组；New 表示新创建的实例个数；Deleted 表示回收的实例个数；Delta 表示增长的实例个数；Alloc Size 表示分配的内存；Freed Size 表示释放的内存；Size Delta 表示增长的内存。</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/ttVWurLoGViaXQR6jiaFpgHt6ib3dwFZibskvBLCSnIHjtk40ib8miaVxicWN9Eg3Q7AQ2GjdN3MKyF5Om3yBz468tWEw/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="img"></p> <p>对比一下 heapdump-2 和 heapdump-1、heapdump-3 和 heapdump-2：</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/ttVWurLoGViaXQR6jiaFpgHt6ib3dwFZibskic5VRFXCaLR5pvQJyDNsnohMJ0RsRuzs3X0tyI3CaXU33EJGIWfvSxg/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="img"></p> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/ttVWurLoGViaXQR6jiaFpgHt6ib3dwFZibskC9KhxC9wdFqbhvicsT1KdZKKKK0QHMxoCTmBr9jYtVSYUErcva3m0mg/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="img"></p> <p>创建的变量实例不断增加，并且没有释放的内存，从这里我们有理由怀疑代码是存在内存泄漏的（确实存在，不然这篇文章就不用写了<img src="https://res.wx.qq.com/mpres/htmledition/images/icon/common/emotion_panel/smiley/smiley_20.png?tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="img">）。</p> <p><strong>Summary</strong></p> <p>接下来看一下 Summary 这个选项，从图中可以看出它有 Constructor、Distance、Shallow Size、Retained Size 共 4 项。Constructor 不再赘述；Distance 表示和根对象的距离，越小表示和根对象越近；Shallow Size 表示变量自身的大小，不包含它引用的变量的大小；Retained Size 不仅包含自身的大小，还包含了引用的变量的大小。</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/ttVWurLoGViaXQR6jiaFpgHt6ib3dwFZibsk7347ma1v79dic2QqiaeaDL29AqcYbze2m1mOqSJd0CaqyOteAvmxh6IA/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="img"></p> <p>从图中可以看出，（string）那一行的 Shallow Size 和 Retained Size 都占据了 100%的内存，所以有必要从这里看起，点击 Distance 最大的那一行（205），可以看到如下信息：</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/ttVWurLoGViaXQR6jiaFpgHt6ib3dwFZibskwpxfj7tedhZ2I4cFCiaibbuYsF0KiatibjIQSDg7nEUNKtkdMS7NFTcZUg/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="img"></p> <p>从图中可以看出该 string 类型的变量是 leakStr，这个变量被 originLeakObject 引用了，originLeakObject 又被 leakMethod 引用了，如此反复。看 Distance 为 202 行的那行，也会得出类似的结果。再对应代码，可以看出代码确实是存在内存泄漏的。</p> <h2 id="原因分析"><a href="#原因分析" aria-hidden="true" class="header-anchor">#</a> 原因分析</h2> <p>通过上面的分析，发现代码确实是存在内存泄漏的，为什么会有内存泄漏呢，让我们仔细分析一下这段代码。</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/ttVWurLoGViaXQR6jiaFpgHt6ib3dwFZibskU1ZqIiaogUzicD3HvmWsR07jueIBsMc2Egs8TJdluhk9cf0jA2o2Ty5Q/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="img"></p> <p>unused 在 testMemoryLeak 中创建，形成一个闭包，该闭包引用了 originLeakObject。leakMethod 也是在 testMemoryLeak 中创建的，也形成了闭包，这个闭包和 unused 共享，所以也引用了 originLeakObject。leakMethod 被赋给了 leakObject，leakObject 是一个全局变量，所以 testMemoryLeak 函数执行完毕之后，leakObject 的内存不会被回收，那么 originLeakObject 的内存也不会被回收，而 originLeakObject 本质上是上一个 leakObject，从而导致 leakStr 的内存不能被回收。由于 setInterval 不断调用 testMemoryLeak，导致大量 leakStr 生成，从而造成了内存泄漏。这个分析的结果，其实在开发者工具中也可以对应起来。</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/ttVWurLoGViaXQR6jiaFpgHt6ib3dwFZibskPdO40icmBVLaefBJfzgwn4pcVjjFeRJiapR5ld0LlTHvwgbibqP8hXFuA/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="img"></p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/xiaomuzhu/front-end-interview/edit/master/fedoc/08-Node/Node.js调试之内存泄漏篇.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/fedoc/08-Node/Node.js多进程底层原理.html" class="prev">
          Node.js 多进程底层原理
        </a></span> <span class="next"><a href="/fedoc/08-Node/初探 Node.js 中的事件循环.html">
          初探 Node.js 中的事件循环
        </a>
        →
      </span></p></div> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/assets/js/app.dcf74adf.js" defer></script><script src="/assets/js/3.d459fbac.js" defer></script><script src="/assets/js/52.64320734.js" defer></script><script src="/assets/js/6.da654ace.js" defer></script>
  </body>
</html>
